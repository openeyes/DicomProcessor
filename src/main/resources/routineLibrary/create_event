var eventData = JSON.parse(getTextIfNullReturnEmptyJson('event_data', null));
var requestData = bindObject('REQUEST_DATA');
var attachmentPdf = getAttachmentDataByAttachmentMnemonicAndBodySite('event_pdf', requestData.bodySiteSnomed);
var eventSubtype = "OCT";

if (typeof requestData.event_subtype != "undefined") {
    eventSubtype = requestData.event_subtype;
}

var eventDisplayOrder = 2;

eventData.$$_XID_Map_$$.forEach(function(data) {
    if (data.$$_XID_$$ == '$$_attachment_data[1]_$$') {
        data.id = attachmentPdf.getId().toString();
        data.request_id = attachmentPdf.getRequestId().toString();
    }
    if (data.$$_XID_$$ == '$$_patient[1]_$$') {
        data.id = requestData.patientId;
    }

    if (data.$$_XID_$$ == '$$_event_date[1]_$$') {
        if (typeof requestData.study_date != "undefined") {
            data.date = convertStudyDateTimeToSqlTime(requestData.study_date, requestData.study_time);
        } else {
            data.date = convertStudyDateTimeToSqlTime(requestData.content_date, requestData.content_time);
        }
    }

    if (data.$$_XID_$$ == '$$_event_subtype[1]_$$') {
        data.event_subtype = eventSubtype;
    }

    if (data.$$_XID_$$ == '$$_event_subtype[2]_$$') {
        data.display_order = eventDisplayOrder;
    }
});

eventData['$$_SaveSet[1]_$$'].forEach(function(data) {
    var dataSet = data.$$_DataSet_$$;
    if (dataSet == "et_ophgeneric_device_information") {
        var deviceInformationRow = data.$$_ROW_$$[0];
        deviceInformationRow.manufacturer = requestData.manufacturer;
        deviceInformationRow.manufacturer_model_name = requestData.manufacturer_model_name;
        deviceInformationRow.modality = requestData.modality;
        deviceInformationRow.series_description = requestData.series_description;
        deviceInformationRow.laterality = requestData.laterality;
        deviceInformationRow.image_laterality = requestData.image_laterality;
        deviceInformationRow.study_description = requestData.study_description;
        deviceInformationRow.document_title = requestData.document_title;
        deviceInformationRow.acquisition_date_time = requestData.acquisition_date_time;
        deviceInformationRow.study_date = requestData.study_date;
        deviceInformationRow.study_time = requestData.study_time;
        deviceInformationRow.content_date = requestData.content_date;
        deviceInformationRow.content_time = requestData.content_time;
        deviceInformationRow.station_name = requestData.station_name;
        deviceInformationRow.operators_name = requestData.operators_name;
        deviceInformationRow.software_version = requestData.software_version;
        deviceInformationRow.study_instance_uid = requestData.study_instance_uid;
        deviceInformationRow.series_instance_uid = requestData.series_instance_uid;
        deviceInformationRow.study_id = requestData.study_id;
        deviceInformationRow.series_number = requestData.series_number;
        deviceInformationRow.instance_number = requestData.instance_number;
        deviceInformationRow.modifying_system = requestData.modifying_system;
        deviceInformationRow.operator_identification_sequence = requestData.operator_identification_sequence;
        deviceInformationRow.sop_instance_uid = requestData.sop_instance_uid;
    }
});

var eventData = createEvent(JSON.stringify(eventData));

putText(
    'event_data',
    eventData,
    'NONE',
    null, 'application/json');
addRoutine('link_attachment_with_event');